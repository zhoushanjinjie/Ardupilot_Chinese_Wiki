<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESC Telemetry Based Harmonic Notch Setup &mdash; Copter  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/common_theme_override.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon_copter.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/./useralerts.js"></script>
        <script data-domain="ardupilot.org" defer="defer" src="https://plausible.ardupilot.org/js/script.outbound-links.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="In-Flight FFT Based Harmonic Notch Setup" href="common-imu-fft.html" />
    <link rel="prev" title="RPM Sensor Based Dynamic Notch Setup" href="common-rpm-based-notch.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Copter
              <img src="../_static/ardupilot_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="copter-introduction.html">Copter简介</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introducing Copter</a></li>
<li class="toctree-l2"><a class="reference internal" href="what-is-a-multicopter-and-how-does-it-work.html">How Multicopters Work</a></li>
<li class="toctree-l2"><a class="reference internal" href="copter-use-case-overview.html">Use-Case Overview</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="copter-flight-features.html">Flight Features</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="common-geofencing-landing-page.html">[site wiki=”plane”]</a></li>
<li class="toctree-l3"><a class="reference internal" href="common-geofencing-landing-page.html#geofencing">GeoFencing</a></li>
<li class="toctree-l3"><a class="reference internal" href="common-geofencing-landing-page.html#detailed-information">Detailed Information</a></li>
<li class="toctree-l3"><a class="reference internal" href="common-object-avoidance-landing-page.html">Object Avoidance</a></li>
<li class="toctree-l3"><a class="reference internal" href="terrain-following.html">Terrain Following (in Auto, Guided, etc)</a></li>
<li class="toctree-l3"><a class="reference internal" href="terrain-following-manual-modes.html">Surface Tracking</a></li>
<li class="toctree-l3"><a class="reference internal" href="motor-thrust-scaling.html">Motor Thrust Scaling</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="common-imu-notch-filtering.html">Notch Filtering</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="common-imu-notch-filtering.html#determining-notch-filter-center-frequency">Determining Notch Filter Center Frequency</a></li>
<li class="toctree-l4"><a class="reference internal" href="common-imu-notch-filtering.html#notch-filter-control-types">Notch Filter Control Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="common-imu-notch-filtering.html#number-of-harmonics-filtered">Number of Harmonics Filtered</a></li>
<li class="toctree-l4"><a class="reference internal" href="common-imu-notch-filtering.html#fft-dynamic-harmonic-notch-frequency-tracking">FFT Dynamic Harmonic Notch Frequency Tracking</a></li>
<li class="toctree-l4"><a class="reference internal" href="common-imu-notch-filtering.html#checking-notch-filter-effectiveness">Checking Notch Filter Effectiveness</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="common-imu-notch-filtering.html#double-triple-notch">Double/Triple-Notch</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="common-moving-vehicle-initialization.html">Moving Vehicle Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="common-non-gps-navigation-landing-page.html">Non-GPS Navigation</a></li>
<li class="toctree-l3"><a class="reference internal" href="weathervaning.html">Weathervaning and Wind Hold</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="choosing-a-frame.html">Choosing a MultiCopter Frame</a></li>
<li class="toctree-l2"><a class="reference internal" href="what-you-need.html">Building Your Own Frame</a></li>
<li class="toctree-l2"><a class="reference internal" href="safety-multicopter.html">MultiCopter Safety</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference-frames.html">Reference Frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="common-rtf.html">Ready to Fly vehicles</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="common-autopilots.html">选择飞控</a></li>
<li class="toctree-l1"><a class="reference internal" href="common-GCS.html">地面站软件</a></li>
<li class="toctree-l1"><a class="reference internal" href="initial-setup.html">首次设置</a></li>
<li class="toctree-l1"><a class="reference internal" href="flying-arducopter.html">首次飞行和调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="traditional-helicopters.html">传统直升机</a></li>
<li class="toctree-l1"><a class="reference internal" href="common-mission-planning.html">任务规划</a></li>
<li class="toctree-l1"><a class="reference internal" href="common-when-problems-arise.html">如果出现问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="common-advanced-configuration.html">高级配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="common-optional-hardware.html">可选硬件</a></li>
<li class="toctree-l1"><a class="reference internal" href="additional-information.html">附加信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="common-user-alerts.html">用户警报</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Copter</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="copter-introduction.html">Copter Introduction</a></li>
          <li class="breadcrumb-item"><a href="copter-flight-features.html">Flight Features</a></li>
          <li class="breadcrumb-item"><a href="common-imu-notch-filtering.html">Managing Gyro Noise with the Dynamic Harmonic Notch Filters</a></li>
      <li class="breadcrumb-item active">ESC Telemetry Based Harmonic Notch Setup</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p id="common-esc-telem-based-notch">[copywiki destination=”copter,plane”]</p>
<section id="esc-telemetry-based-harmonic-notch-setup">
<h1>ESC Telemetry Based Harmonic Notch Setup<a class="headerlink" href="#esc-telemetry-based-harmonic-notch-setup" title="Permalink to this heading">¶</a></h1>
<p id="esc-telemetry-based-dynamic-notch-filter">If ESCs with telemetry are used (either via a separate telemety wire or bi-directional dshot) then the harmonic notch reference frequency can be set dynamically using ESC telemetry.  The harmonic notch reference frequency parameter, <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntch-freq" title="(in Rover)"><span class="xref std std-ref">INS_HNTCH_FREQ</span></a> and/or <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntc2-freq" title="(in Rover)"><span class="xref std std-ref">INS_HNTC2_FREQ</span></a>, is used to indicate the lowest motor speed for which the ESC telemetry should be used to dynamically set the harmonic notch reference frequency.  It is recommended that this be set to below the hover frequency but above the <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-gyro-filter" title="(in Rover)"><span class="xref std std-ref">INS_GYRO_FILTER</span></a> frequency.</p>
<ul class="simple">
<li><p>Set the <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntch-ref" title="(in Rover)"><span class="xref std std-ref">INS_HNTCH_REF</span></a> and/or <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntc2-ref" title="(in Rover)"><span class="xref std std-ref">INS_HNTC2_REF</span></a> parameter to 1, which will disable scaling of the harmonic notch, and set <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntch-mode" title="(in Rover)"><span class="xref std std-ref">INS_HNTCH_MODE</span></a> and/or <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntc2-mode" title="(in Rover)"><span class="xref std std-ref">INS_HNTC2_MODE</span></a> to 3 to select ESC telemetry.</p></li>
<li><p>Set <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntch-mode" title="(in Rover)"><span class="xref std std-ref">INS_HNTCH_MODE</span></a> and/or <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntc2-mode" title="(in Rover)"><span class="xref std std-ref">INS_HNTC2_MODE</span></a> = 3 to use BLHeli ESC telemetry support to set the harmonic notch frequency. This requires that your ESCs are configured correctly to support BLHeli telemetry via <a class="reference internal" href="common-esc-telemetry.html#blheli32-esc-telemetry"><span class="std std-ref">a serial port</span></a> or are Bi-directional DShot capable and using Ardupilot autopilot and firmware which supports that capability.</p></li>
<li><p>Set <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntch-enable" title="(in Rover)"><span class="xref std std-ref">INS_HNTCH_ENABLE</span></a> and/or <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntc2-enable" title="(in Rover)"><span class="xref std std-ref">INS_HNTC2_ENABLE</span></a> = 1 to enable the harmonic notch</p></li>
<li><p>Set <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntch-freq" title="(in Rover)"><span class="xref std std-ref">INS_HNTCH_FREQ</span></a> and/or <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntc2-freq" title="(in Rover)"><span class="xref std std-ref">INS_HNTC2_FREQ</span></a> = below the hover frequency - you can easily determine this by performing a gentle hover and looking at the ESC telemetry data</p></li>
<li><p>Set <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntch-bw" title="(in Rover)"><span class="xref std std-ref">INS_HNTCH_BW</span></a> and/or <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntc2-bw" title="(in Rover)"><span class="xref std std-ref">INS_HNTC2_BW</span></a> = half of INS_HNTCH_FREQ</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you set the dynamic harmonics option (i.e. a notch per motor) mentioned below, the bandwidth should not be half the frequency. It should be greatly reduced as more notches cause more phase lag (i.e. latency), thus the bandwidth needs to be reduced to maintain a reasonable phase lag, else oscillation and a poorer tune will result despite the more accurate filtering compared to throttle-based filtering. For example, with four motors, <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntch-freq" title="(in Rover)"><span class="xref std std-ref">INS_HNTCH_FREQ</span></a> / 4 is suggested as a starting point.
This is because for notch filters, a wider bandwidth causes a greater phase lag per notch.
You can also use the <a class="reference external" href="https://firmware.ardupilot.org/Tools/FilterTool/">Filter Tool</a> to check the phase lag for your chosen filtering settings. If your phase lag is higher than it was with the throttle-based notch, then you can try reducing the bandwidth even further, balancing the phase lag and the amount of noise in the system.</p>
</div>
<section id="center-frequency-slewing">
<h2>Center Frequency Slewing<a class="headerlink" href="#center-frequency-slewing" title="Permalink to this heading">¶</a></h2>
<p>The rate at which the harmonic notch frequency is updated has a big impact on noise in the PID loops. Slower update rates mean that the frequency has larger step changes which result in what is called shot noise. Faster update rates reduce this and is the primary reason why using bi-directional dshot with ESC Telemetry reporting of RPM benefits the system overall.</p>
<p>By default the update rate is 200Hz and where the source of frequency information is slower than that - for instance when using ESC telemetry where the maximum rate that can be sustained is about 100Hz - ArduPilot will slew the frequency changes at 200Hz to avoid large steps. The slewed rate is the rate that is reported by ESC telemetry, although the raw rate can be seen in the logs as well.</p>
<p>On systems with faster CPUs (H7 based autopilots) it is possible to update the harmonic notch at the main loop rates used for VTOL aircraft (typically 300-400Hz set by <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#sched-loop-rate" title="(in Rover)"><span class="xref std std-ref">SCHED_LOOP_RATE</span></a>) by setting bit 3 of the notch options, i.e.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntch-opts" title="(in Rover)"><span class="xref std std-ref">INS_HNTCH_OPTS</span></a> and/or <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntc2-opts" title="(in Rover)"><span class="xref std std-ref">INS_HNTC2_OPTS</span></a> = 4</p></li>
</ul>
<p>Slewing ensures that the step changes at each update tick are smooth, but for optimum system performance you can use bi-directional Dshot ESCs which can deliver frequency updates at 400Hz, using the above option, if possible .</p>
</section>
<section id="checking-harmonic-notch-effectiveness">
<h2>Checking Harmonic Notch Effectiveness<a class="headerlink" href="#checking-harmonic-notch-effectiveness" title="Permalink to this heading">¶</a></h2>
<p>Once the notch filter(s) are setup, the effectiveness of them can be checked by again measuring the  frequency spectrum of the output of the filters (which are the new inputs to the IMU sensors). Refer back to the <a class="reference internal" href="common-imu-batchsampling.html#common-imu-batchsampling"><span class="std std-ref">Measuring Vibration with IMU Batch Sampler</span></a>  page for this.</p>
<p>While the log analysis of noise frequencies is not absolutely required prior to notch setup for RPM based mode, the logging and analysis done for the Confirmation flight using that method can be done in order to confirm the noise elimination, if desired.</p>
</section>
<section id="dynamic-harmonics">
<h2>Dynamic Harmonics<a class="headerlink" href="#dynamic-harmonics" title="Permalink to this heading">¶</a></h2>
<p>By default the ESC based harmonic notch will use an average of the individual motor frequencies in order to drive the center frequency of the notch, this average is then used as the first harmonic and other harmonic notches are added at higher frequency multiples of the first harmonic. It is also possible to configure the harmonics to instead be first harmonics per motor. This gives four notches - one for each motor - that exactly tracks the motor speed. In dynamic flight this can give much better noise attenuation.</p>
<p>To configure this option set <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntch-opts" title="(in Rover)"><span class="xref std std-ref">INS_HNTCH_OPTS</span></a> and/or <a class="reference external" href="https://ardupilot.org/rover/docs/parameters.html#ins-hntch-opts" title="(in Rover)"><span class="xref std std-ref">INS_HNTCH_OPTS</span></a> to “2”</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="common-rpm-based-notch.html" class="btn btn-neutral float-left" title="RPM Sensor Based Dynamic Notch Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="common-imu-fft.html" class="btn btn-neutral float-right" title="In-Flight FFT Based Harmonic Notch Setup" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, ArduPilot Dev Team.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>